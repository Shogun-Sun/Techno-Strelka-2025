<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>Геолокация и район</title>
    <script
      src="https://api-maps.yandex.ru/2.1/?apikey=cfb17578-6c78-4dbc-9099-c50949c99d19&lang=ru_RU"
      type="text/javascript"
    ></script>
  </head>
  <body>
    <h2>Геолокация и район</h2>
    <script>
      ymaps.ready(() => {
        // Проверяем, поддерживает ли браузер геолокацию
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            async (position) => {
              const lat = position.coords.latitude;
              const lon = position.coords.longitude;
              const coords = [56.316309, 43.927515];

              try {
                // Получаем адрес с помощью Яндекс API
                const addressResult = await ymaps.geocode(coords);

                // Получаем первый геообъект (адрес)
                const firstGeoObject = addressResult.geoObjects.get(0);

                if (firstGeoObject) {
                  const components = firstGeoObject.properties.get('metaDataProperty.GeocoderMetaData.Address.Components');
                  let district = 'Не удалось найти район';
                  components.forEach(component => {
                    if (component.kind === 'district') {
                      district = component.name;
                    }
                  });

                  // Сообщение
                  fetch('http://localhost:3000/chips/get', {
                    method: 'POST',
                    headers: {
                      'Accept': '*/*',
                      'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                      chip_district: district,
                    }),
                  })
                  .then(response => {
                    if (!response.ok) {
                      return response.json().then(err => { throw new Error(err.message); });
                    }
                    return response.json();
                  })
                  .then(data => alert(data.chip_description))
                  .catch(error => console.log(error.message));
                  
                  
                } else {
                  alert('Не удалось найти район.');
                }
              } catch (err) {
                console.error('Ошибка при получении данных геокодирования:', err);
                alert('Не удалось получить информацию о районе.');
              }
            },
            (error) => {
              console.error('Ошибка геолокации:', error);
              alert('Не удалось получить координаты пользователя.');
            },
            {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 0
            }
          );
        } else {
          alert('Геолокация не поддерживается этим браузером.');
        }
      });
    </script>
  </body>
</html>
